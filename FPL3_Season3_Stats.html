<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FPL Season 3 — Stats Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root{--bg:#06060c;--bg2:#0c0c16;--bg3:#12121e;--border:#1a1a30;--cyan:#00f0ff;--cyan-dim:#00f0ff25;--pink:#ff2d7b;--purple:#a855f7;--green:#22c55e;--gold:#ffd700;--silver:#c0c0c0;--bronze:#cd7f32;--text:#e2e8f0;--dim:#4a5568}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'Rajdhani',sans-serif;min-height:100vh}
body::before{content:'';position:fixed;inset:0;background:linear-gradient(90deg,#00f0ff05 1px,transparent 1px),linear-gradient(0deg,#00f0ff05 1px,transparent 1px);background-size:50px 50px;z-index:0;animation:gp 6s ease-in-out infinite}
@keyframes gp{0%,100%{opacity:.3}50%{opacity:.6}}
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,#00000008 2px,#00000008 4px);pointer-events:none;z-index:100}
.wrap{max-width:1100px;margin:0 auto;padding:16px;position:relative;z-index:1}
.hdr{text-align:center;padding:32px 0 24px;position:relative}
.hdr::after{content:'';position:absolute;bottom:0;left:10%;right:10%;height:1px;background:linear-gradient(90deg,transparent,var(--cyan),transparent)}
.badge{display:inline-block;padding:3px 14px;border:1px solid var(--cyan);font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:4px;text-transform:uppercase;color:var(--cyan);background:var(--cyan-dim);animation:bp 3s ease-in-out infinite}
@keyframes bp{0%,100%{box-shadow:0 0 8px #00f0ff15}50%{box-shadow:0 0 20px #00f0ff35}}
.hdr h1{font-family:'Orbitron',sans-serif;font-size:clamp(24px,5vw,46px);font-weight:900;letter-spacing:2px;margin:10px 0 4px;background:linear-gradient(135deg,#fff 0%,var(--cyan) 50%,var(--pink) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hdr .sub{font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--dim);letter-spacing:2px}
.hdr .cred{font-size:11px;color:var(--dim);margin-top:6px;opacity:.5}
.meta-bar{display:flex;justify-content:center;gap:24px;margin:12px 0 0;flex-wrap:wrap}
.meta-item{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--dim)}
.meta-item span{color:var(--cyan);font-weight:700}

/* ─── Tab Navigation ─── */
.tab-nav{display:flex;gap:2px;margin:20px 0 16px;flex-wrap:wrap;border-bottom:1px solid var(--border);padding-bottom:0}
.tab-btn{background:transparent;border:1px solid transparent;border-bottom:none;color:var(--dim);font-family:'Orbitron',sans-serif;font-size:10px;font-weight:700;letter-spacing:1px;padding:10px 16px;cursor:pointer;transition:all .2s;text-transform:uppercase;position:relative;bottom:-1px}
.tab-btn:hover{color:var(--text);background:var(--bg2)}
.tab-btn.active{color:var(--cyan);border-color:var(--border);border-bottom-color:var(--bg);background:var(--bg)}
.tab-page{display:none}
.tab-page.active{display:block}

/* ─── Global Filters ─── */
.gfilters{display:flex;gap:10px;margin:0 0 16px;flex-wrap:wrap;align-items:end}
.gfilters .ctrl{min-width:120px}

/* ─── Controls ─── */
.ctrls{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin:0 0 8px}
.ctrls2{display:grid;grid-template-columns:auto 1fr 1fr;gap:10px;margin:0 0 16px}
@media(max-width:768px){.ctrls{grid-template-columns:repeat(3,1fr)}.ctrls2{grid-template-columns:1fr 1fr}}
@media(max-width:480px){.ctrls{grid-template-columns:1fr 1fr}.ctrls2{grid-template-columns:1fr}}
.ctrl{min-width:0}
.ctrl label{display:block;font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--cyan);margin-bottom:4px}
.ctrl select{width:100%;background:var(--bg2);border:1px solid var(--border);color:var(--text);font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:600;padding:8px 12px;appearance:none;cursor:pointer;transition:all .2s;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%2300f0ff' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center}
.ctrl select:focus{outline:none;border-color:var(--cyan);box-shadow:0 0 15px #00f0ff15}
.tog{display:flex;gap:3px}
.tbtn{flex:1;background:var(--bg2);border:1px solid var(--border);color:var(--dim);font-family:'Orbitron',sans-serif;font-size:9px;font-weight:700;letter-spacing:1px;padding:8px 4px;cursor:pointer;transition:all .2s;white-space:nowrap}
.tbtn:hover{border-color:var(--dim)}
.tbtn.ah{background:linear-gradient(135deg,#00f0ff15,#22c55e15);border-color:var(--green);color:var(--green);box-shadow:0 0 12px #22c55e15}
.tbtn.al{background:linear-gradient(135deg,#ff2d7b15,#ef444415);border-color:var(--pink);color:var(--pink);box-shadow:0 0 12px #ff2d7b15}
.tbtn.aa{background:linear-gradient(135deg,#00f0ff15,#a855f715);border-color:var(--purple);color:var(--purple);box-shadow:0 0 12px #a855f715}
.role-checks{display:flex;gap:4px;flex-wrap:wrap}
.rc{cursor:pointer}
.rc input{display:none}
.rb{display:block;padding:6px 10px;font-family:'Orbitron',sans-serif;font-size:10px;font-weight:700;letter-spacing:1px;border:1px solid var(--border);background:var(--bg2);color:var(--dim);transition:all .2s;text-align:center}
.rc input:checked+.rb{border-color:var(--rc);color:var(--rc);background:color-mix(in srgb,var(--rc) 15%,var(--bg2))}
.rc:hover .rb{border-color:var(--dim)}

/* ─── Cards ─── */
.card{background:var(--bg3);border:1px solid var(--border);padding:20px;margin-bottom:16px;backdrop-filter:blur(8px);position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--cyan),var(--pink),var(--purple))}
.card-t{font-family:'Orbitron',sans-serif;font-size:13px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-bottom:2px}
.card-s{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--dim);margin-bottom:20px}

/* ─── Bar Rows ─── */
.brow{display:grid;grid-template-columns:32px 220px 1fr 80px;align-items:center;gap:8px;margin-bottom:5px;opacity:0;transform:translateX(-15px);animation:si .35s ease forwards;cursor:pointer}
.brow:hover{background:#ffffff06}
.brow.selected{background:linear-gradient(90deg,#00f0ff08,transparent)}
@media(max-width:600px){.brow{grid-template-columns:24px 140px 1fr 55px;gap:4px}}
.brow .rk{font-family:'Orbitron',sans-serif;font-size:11px;font-weight:800;color:var(--dim);text-align:center}
.brow .rk.r1{color:var(--gold);text-shadow:0 0 8px #ffd70040}
.brow .rk.r2{color:var(--silver)}
.brow .rk.r3{color:var(--bronze)}
.brow .pi{overflow:hidden}
.brow .pn{font-weight:700;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.brow .tn{font-family:'Rajdhani',sans-serif;font-size:11px;font-weight:500;color:#94a3b8;white-space:nowrap;overflow:visible}
.bc{height:26px;background:#ffffff06;position:relative;overflow:hidden}
.bf{height:100%;position:relative;transition:width .7s cubic-bezier(.22,1,.36,1);min-width:3px}
.bf::after{content:'';position:absolute;right:0;top:0;bottom:0;width:2px;background:#fff;opacity:.7;box-shadow:0 0 6px currentColor}
.brow .val{font-family:'Orbitron',sans-serif;font-size:13px;font-weight:700;text-align:right}
@keyframes si{to{opacity:1;transform:translateX(0)}}
.player-count{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--dim);margin-top:12px;padding-top:10px;border-top:1px solid var(--border);text-align:center}

/* ─── Compare Dock ─── */
.cmp-dock{background:var(--bg3);border:1px solid var(--border);padding:20px;margin-bottom:16px;position:relative;overflow:hidden;display:none}
.cmp-dock.active{display:block}
.cmp-dock::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--pink),var(--cyan),var(--purple))}
.cmp-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.cmp-title{font-family:'Orbitron',sans-serif;font-size:13px;font-weight:700;letter-spacing:2px;text-transform:uppercase}
.cmp-clear{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--pink);cursor:pointer;letter-spacing:1px;padding:4px 10px;border:1px solid var(--pink);background:transparent;transition:all .2s}
.cmp-clear:hover{background:#ff2d7b15}
.cmp-body{display:flex;gap:20px;align-items:flex-start}
@media(max-width:768px){.cmp-body{flex-direction:column;align-items:center}}
.cmp-radar{flex:0 0 280px;height:280px;position:relative}
@media(max-width:600px){.cmp-radar{flex:0 0 220px;height:220px}}
.cmp-cards{flex:1;display:flex;gap:12px;flex-wrap:wrap}
.cmp-card{flex:1;min-width:180px;max-width:280px;background:var(--bg2);border:1px solid var(--border);padding:14px;position:relative}
.cmp-card .cmp-accent{position:absolute;top:0;left:0;right:0;height:2px}
.cmp-card .cmp-name{font-family:'Orbitron',sans-serif;font-size:12px;font-weight:700;margin-bottom:2px}
.cmp-card .cmp-sub{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--dim);margin-bottom:10px}
.cmp-card .cmp-stats{display:grid;grid-template-columns:1fr 1fr;gap:4px 12px}
.cmp-card .cmp-stat{display:flex;justify-content:space-between;font-size:12px}
.cmp-card .cmp-stat .cmp-label{color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:9px}
.cmp-card .cmp-stat .cmp-val{font-family:'Orbitron',sans-serif;font-size:11px;font-weight:700}
.cmp-card .cmp-remove{position:absolute;top:8px;right:8px;background:none;border:none;color:var(--dim);font-size:14px;cursor:pointer;line-height:1;padding:2px 6px;transition:color .2s}
.cmp-card .cmp-remove:hover{color:var(--pink)}
.cmp-empty{flex:1;min-width:180px;max-width:280px;border:1px dashed var(--border);padding:30px 14px;text-align:center;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--dim);letter-spacing:1px}
.cmp-hint{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--dim);text-align:center;margin-bottom:12px;letter-spacing:1px}

/* ─── Teams Page ─── */
.team-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
.team-card{background:var(--bg2);border:1px solid var(--border);padding:16px;position:relative;overflow:hidden;cursor:default;transition:border-color .2s}
.team-card:hover{border-color:var(--dim)}
.team-card .tc-accent{position:absolute;top:0;left:0;right:0;height:3px}
.team-card .tc-name{font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700;margin-bottom:2px}
.team-card .tc-record{font-family:'Share Tech Mono',monospace;font-size:11px;margin-bottom:10px}
.team-card .tc-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.team-card .tc-stat{text-align:center}
.team-card .tc-stat-val{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:700}
.team-card .tc-stat-label{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--dim);letter-spacing:1px;text-transform:uppercase}
.team-card .tc-roster{margin-top:10px;padding-top:10px;border-top:1px solid var(--border);font-size:12px;color:var(--dim)}
.team-card .tc-roster span{color:var(--text);cursor:pointer;transition:color .2s}
.team-card .tc-roster span:hover{color:var(--cyan)}

/* ─── Champions Page ─── */
.champ-table{width:100%;border-collapse:collapse}
.champ-table th{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--cyan);padding:8px 6px;text-align:left;border-bottom:1px solid var(--border);cursor:pointer;transition:color .2s;user-select:none;white-space:nowrap}
.champ-table th:hover{color:var(--text)}
.champ-table th.sorted{color:var(--pink)}
.champ-table td{font-size:13px;padding:6px;border-bottom:1px solid #ffffff06}
.champ-table tr:hover td{background:#ffffff04}
.champ-table .champ-name{font-weight:700}
.champ-table .champ-bar{height:4px;background:#ffffff08;min-width:60px;position:relative;display:inline-block;vertical-align:middle;margin-left:6px}
.champ-table .champ-bar-fill{height:100%;position:absolute;left:0;top:0}

/* ─── Records Page ─── */
.records-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px}
.record-card{background:var(--bg2);border:1px solid var(--border);padding:16px;position:relative;overflow:hidden}
.record-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--gold),var(--cyan))}
.record-card .rec-cat{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--cyan);text-transform:uppercase;margin-bottom:8px}
.record-card .rec-val{font-family:'Orbitron',sans-serif;font-size:28px;font-weight:900;margin-bottom:4px}
.record-card .rec-player{font-weight:700;font-size:14px}
.record-card .rec-detail{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--dim);margin-top:4px}

/* ─── MVP Page ─── */
.mvp-section{margin-bottom:24px}
.mvp-crown{text-align:center;padding:30px 20px;background:linear-gradient(135deg,var(--bg2),var(--bg3));border:1px solid var(--border);position:relative;overflow:hidden;margin-bottom:16px}
.mvp-crown::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--gold),var(--cyan),var(--gold))}
.mvp-crown .mvp-label{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--gold);letter-spacing:4px;text-transform:uppercase}
.mvp-crown .mvp-name{font-family:'Orbitron',sans-serif;font-size:clamp(20px,4vw,36px);font-weight:900;color:var(--gold);margin:8px 0 4px;text-shadow:0 0 20px #ffd70030}
.mvp-crown .mvp-sub{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--dim)}
.mvp-crown .mvp-score{font-family:'Orbitron',sans-serif;font-size:48px;font-weight:900;background:linear-gradient(135deg,var(--gold),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin:12px 0}
.mvp-weekly{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px}
.mvp-week-card{background:var(--bg2);border:1px solid var(--border);padding:12px;text-align:center}
.mvp-week-card .mwc-date{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--dim);letter-spacing:1px}
.mvp-week-card .mwc-name{font-family:'Orbitron',sans-serif;font-size:12px;font-weight:700;margin:4px 0}
.mvp-week-card .mwc-score{font-family:'Orbitron',sans-serif;font-size:18px;font-weight:900}
.mvp-week-card .mwc-line{font-size:11px;color:var(--dim)}

/* ─── Power Rankings ─── */
.pr-row{display:grid;grid-template-columns:40px 200px 1fr 70px;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #ffffff06;opacity:0;transform:translateX(-15px);animation:si .35s ease forwards}
.pr-row .pr-rank{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:900;text-align:center}
.pr-row .pr-info .pr-name{font-weight:700;font-size:14px;cursor:pointer;transition:color .2s}
.pr-row .pr-info .pr-name:hover{color:var(--cyan)}
.pr-row .pr-info .pr-detail{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--dim)}
.pr-row .pr-bar{height:30px;background:#ffffff06;position:relative;overflow:hidden}
.pr-row .pr-bar-fill{height:100%;position:relative;transition:width .7s cubic-bezier(.22,1,.36,1)}
.pr-row .pr-bar-fill::after{content:'';position:absolute;right:0;top:0;bottom:0;width:2px;background:#fff;opacity:.7}
.pr-row .pr-score{font-family:'Orbitron',sans-serif;font-size:16px;font-weight:700;text-align:right}
.pr-breakdown{display:flex;gap:4px;margin-top:2px}
.pr-pip{width:8px;height:8px;border-radius:50%;display:inline-block;opacity:.6}

/* ─── Player Profile Modal ─── */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:200;overflow-y:auto}
.modal-overlay.active{display:flex;justify-content:center;padding:40px 16px}
.modal{background:var(--bg);border:1px solid var(--border);max-width:900px;width:100%;padding:24px;position:relative;max-height:fit-content}
.modal::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--cyan),var(--pink),var(--purple))}
.modal-close{position:absolute;top:12px;right:16px;background:none;border:none;color:var(--dim);font-size:24px;cursor:pointer;transition:color .2s;z-index:1}
.modal-close:hover{color:var(--pink)}
.prof-header{display:flex;gap:20px;align-items:center;margin-bottom:20px;flex-wrap:wrap}
.prof-name{font-family:'Orbitron',sans-serif;font-size:24px;font-weight:900}
.prof-sub{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--dim)}
.prof-rating{font-family:'Orbitron',sans-serif;font-size:36px;font-weight:900;margin-left:auto}
.prof-section{margin-bottom:20px}
.prof-section-title{font-family:'Orbitron',sans-serif;font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--cyan);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.prof-stats{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
.prof-stat{background:var(--bg2);padding:10px;text-align:center}
.prof-stat-val{font-family:'Orbitron',sans-serif;font-size:18px;font-weight:700}
.prof-stat-label{font-family:'Share Tech Mono',monospace;font-size:8px;color:var(--dim);letter-spacing:1px;text-transform:uppercase;margin-top:2px}
.prof-stat-rank{font-family:'Share Tech Mono',monospace;font-size:9px;margin-top:2px}
.prof-champs{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px}
.prof-champ{background:var(--bg2);padding:10px;display:flex;justify-content:space-between;align-items:center}
.prof-champ-name{font-weight:700;font-size:13px}
.prof-champ-wr{font-family:'Orbitron',sans-serif;font-size:11px;font-weight:700}
.prof-champ-games{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--dim)}
.prof-trend{position:relative;height:120px;margin-top:10px}
.prof-vs-avg{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:6px;margin-top:10px}
.prof-vs{background:var(--bg2);padding:8px 10px;display:flex;justify-content:space-between;align-items:center;font-size:12px}
.prof-vs .pvl{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--dim)}
.prof-vs .pvv{font-family:'Orbitron',sans-serif;font-size:11px;font-weight:700}
.prof-vs .pvd{font-family:'Share Tech Mono',monospace;font-size:9px}

/* ─── Utilities ─── */
.nodata{text-align:center;padding:50px 0;font-family:'Share Tech Mono',monospace;color:var(--dim);font-size:12px}
.loading{text-align:center;padding:80px 0}
.loading .spin{display:inline-block;width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--cyan);border-radius:50%;animation:sp .8s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.loading p{font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--cyan);margin-top:16px;letter-spacing:2px}
.load-error{text-align:center;padding:60px 0;font-family:'Share Tech Mono',monospace;color:var(--pink);font-size:12px}
.ftr{text-align:center;padding:30px 0 16px;font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--dim);letter-spacing:2px;opacity:.3}

/* ─── Back to Top ─── */
.btt{position:fixed;bottom:24px;right:24px;width:40px;height:40px;background:var(--bg3);border:1px solid var(--border);color:var(--cyan);font-size:18px;cursor:pointer;z-index:50;display:none;align-items:center;justify-content:center;transition:all .2s;font-family:'Orbitron',sans-serif}
.btt:hover{background:var(--cyan);color:var(--bg);box-shadow:0 0 20px #00f0ff30}
.btt.show{display:flex}

/* ─── Share Link Toast ─── */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--bg3);border:1px solid var(--cyan);padding:10px 20px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--cyan);z-index:300;transition:transform .3s ease;letter-spacing:1px;box-shadow:0 0 20px #00f0ff20}
.toast.show{transform:translateX(-50%) translateY(0)}

/* ─── Profile Share Button ─── */
.prof-share{background:transparent;border:1px solid var(--cyan);color:var(--cyan);font-family:'Share Tech Mono',monospace;font-size:10px;padding:6px 14px;cursor:pointer;letter-spacing:1px;transition:all .2s;margin-left:12px}
.prof-share:hover{background:var(--cyan);color:var(--bg)}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border)}::-webkit-scrollbar-thumb:hover{background:var(--cyan)}
</style>
</head>
<body>
<div class="wrap">
  <header class="hdr">
    <div class="badge">Season 3 // Official Stats</div>
    <h1>FRANCHISE PREMIER LEAGUE</h1>
    <div class="sub">PLAYER PERFORMANCE DASHBOARD</div>
    <div class="cred">Stats compiled by Drib x Lizzo Mukkbang</div>
    <div class="meta-bar">
      <div class="meta-item"><span id="mPlayers">—</span> Players</div>
      <div class="meta-item"><span id="mMatches">—</span> Matches</div>
      <div class="meta-item"><span id="mTeams">12</span> Teams</div>
      <div class="meta-item"><span id="mNights">—</span> Game Nights</div>
      <div class="meta-item" id="mDates">Loading…</div>
      <div class="meta-item">Updated: <span id="mUpdated">—</span></div>
    </div>
  </header>

  <!-- Global Filters -->
  <div class="gfilters">
    <div class="ctrl">
      <label>Season</label>
      <select id="seasonSel" onchange="onGlobalFilter()">
        <option value="All">All Seasons</option>
        <option value="S3" selected>Season 3</option>
        <option value="S2">Season 2</option>
        <option value="S1">Season 1</option>
      </select>
    </div>
    <div class="ctrl">
      <label>Phase</label>
      <select id="phaseSel" onchange="onGlobalFilter()">
        <option value="All">All</option>
        <option value="Regular">Regular</option>
        <option value="Playoffs">Playoffs</option>
      </select>
    </div>
  </div>

  <!-- Tab Navigation -->
  <nav class="tab-nav" id="tabNav">
    <button class="tab-btn active" data-tab="leaderboard">Leaderboard</button>
    <button class="tab-btn" data-tab="teams">Teams</button>
    <button class="tab-btn" data-tab="champions">Champions</button>
    <button class="tab-btn" data-tab="records">Records</button>
    <button class="tab-btn" data-tab="mvp">MVP</button>
    <button class="tab-btn" data-tab="power">Power Rankings</button>
  </nav>

  <!-- Loading -->
  <div class="loading" id="loadingEl"><div class="spin"></div><p>LOADING MATCH DATA...</p></div>

  <!-- ═══════════ LEADERBOARD TAB ═══════════ -->
  <div class="tab-page active" id="pg-leaderboard" style="display:none">
    <div class="ctrls" id="ctrlsWrap">
      <div class="ctrl">
        <label>Stat</label>
        <select id="statSel" onchange="renderLeaderboard()"></select>
      </div>
      <div class="ctrl">
        <label>View</label>
        <div class="tog">
          <button class="tbtn ah" id="bHigh" onclick="setType('top10')">▲ TOP 10</button>
          <button class="tbtn" id="bLow" onclick="setType('bot10')">▼ BOT 10</button>
          <button class="tbtn" id="bAll" onclick="setType('all')">ALL</button>
        </div>
      </div>
      <div class="ctrl"><label>&nbsp;</label><div></div></div>
      <div class="ctrl"><label>&nbsp;</label><div></div></div>
      <div class="ctrl">
        <label>Min Games</label>
        <select id="minGSel" onchange="renderLeaderboard()">
          <option value="1">1+</option><option value="3">3+</option><option value="5" selected>5+</option><option value="8">8+</option><option value="10">10+</option>
        </select>
      </div>
    </div>
    <div class="ctrls2">
      <div class="ctrl">
        <label>Role</label>
        <div class="role-checks" id="roleChecks">
          <label class="rc"><input type="checkbox" value="TOP" checked onchange="renderLeaderboard()"><span class="rb" style="--rc:#ef4444">Top</span></label>
          <label class="rc"><input type="checkbox" value="JUNGLE" checked onchange="renderLeaderboard()"><span class="rb" style="--rc:#22c55e">Jng</span></label>
          <label class="rc"><input type="checkbox" value="MIDDLE" checked onchange="renderLeaderboard()"><span class="rb" style="--rc:#3b82f6">Mid</span></label>
          <label class="rc"><input type="checkbox" value="BOTTOM" checked onchange="renderLeaderboard()"><span class="rb" style="--rc:#f59e0b">Adc</span></label>
          <label class="rc"><input type="checkbox" value="UTILITY" checked onchange="renderLeaderboard()"><span class="rb" style="--rc:#a855f7">Sup</span></label>
        </div>
      </div>
      <div class="ctrl">
        <label>FPL Team</label>
        <select id="teamSel" onchange="renderLeaderboard()"></select>
      </div>
      <div class="ctrl">
        <label>Search Player</label>
        <input type="text" id="searchBar" placeholder="Type a name..." oninput="renderLeaderboard()" style="width:100%;background:var(--bg2);border:1px solid var(--border);color:var(--text);font-family:'Rajdhani',sans-serif;font-size:14px;font-weight:600;padding:8px 12px;transition:all .2s;outline:none" onfocus="this.style.borderColor='var(--cyan)';this.style.boxShadow='0 0 15px #00f0ff15'" onblur="this.style.borderColor='var(--border)';this.style.boxShadow='none'">
      </div>
    </div>
    <div class="card">
      <div class="card-t" id="chartTitle"></div>
      <div class="card-s" id="chartSub"></div>
      <div id="bars"></div>
      <div class="player-count" id="playerCount"></div>
    </div>
    <div class="cmp-dock" id="cmpDock">
      <div class="cmp-header"><div class="cmp-title">⚔ Player Comparison</div><button class="cmp-clear" onclick="clearCompare()">CLEAR ALL</button></div>
      <div class="cmp-hint">Click players on the leaderboard to compare (up to 3)</div>
      <div class="cmp-body">
        <div class="cmp-radar"><canvas id="radarCanvas" width="280" height="280"></canvas></div>
        <div class="cmp-cards" id="cmpCards"></div>
      </div>
    </div>
  </div>

  <!-- ═══════════ TEAMS TAB ═══════════ -->
  <div class="tab-page" id="pg-teams">
    <div class="card"><div class="card-t">Team Standings</div><div class="card-s">Win/Loss Records & Team Stats</div><div id="teamGrid" class="team-grid"></div></div>
  </div>

  <!-- ═══════════ CHAMPIONS TAB ═══════════ -->
  <div class="tab-page" id="pg-champions">
    <div class="card"><div class="card-t">Champion Statistics</div><div class="card-s">League-wide champion performance</div><div id="champContent"></div></div>
  </div>

  <!-- ═══════════ RECORDS TAB ═══════════ -->
  <div class="tab-page" id="pg-records">
    <div class="card"><div class="card-t">League Records</div><div class="card-s">All-time single-game records</div><div id="recordsGrid" class="records-grid"></div></div>
  </div>

  <!-- ═══════════ MVP TAB ═══════════ -->
  <div class="tab-page" id="pg-mvp">
    <div id="mvpContent"></div>
  </div>

  <!-- ═══════════ POWER RANKINGS TAB ═══════════ -->
  <div class="tab-page" id="pg-power">
    <div class="card">
      <div class="card-t">Power Rankings</div>
      <div class="card-s">Composite player rating based on weighted stats</div>
      <div style="margin-bottom:12px">
        <div class="ctrl" style="max-width:200px">
          <label>Min Games</label>
          <select id="prMinG" onchange="renderPower()">
            <option value="1">1+</option><option value="3">3+</option><option value="5" selected>5+</option><option value="8">8+</option>
          </select>
        </div>
      </div>
      <div id="powerContent"></div>
    </div>
  </div>

  <!-- ═══════════ PLAYER PROFILE MODAL ═══════════ -->
  <div class="modal-overlay" id="profileModal">
    <div class="modal">
      <button class="modal-close" onclick="closeProfile()">✕</button>
      <div id="profileContent"></div>
    </div>
  </div>

  <div class="ftr">FPL SEASON 3 — FRANCHISE PREMIER LEAGUE — POWERED BY RIOT API — LIVE FROM GOOGLE SHEETS</div>
</div>

<!-- Back to Top -->
<button class="btt" id="bttBtn" onclick="window.scrollTo({top:0,behavior:'smooth'})" title="Back to top">▲</button>

<!-- Toast notification -->
<div class="toast" id="toast"></div>

<script>
// ════════════════════════════════════════
// DATA & CONFIG
// ════════════════════════════════════════
const SHEET_ID = '1QBei0BJqnxJLu68sxNoW8sJCR3SElQA0g_ESQMecHlU';

function loadSheetJSONP(sheet) {
  return new Promise((resolve, reject) => {
    const cbName = '_gviz_cb_' + Math.random().toString(36).slice(2);
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:${cbName}&sheet=${encodeURIComponent(sheet)}`;
    window[cbName] = function(response) {
      delete window[cbName]; document.body.removeChild(script);
      try {
        const cols = response.table.cols.map(c => c.label || c.id);
        const rows = response.table.rows.map(r => {
          const obj = {};
          r.c.forEach((cell, i) => { obj[cols[i]] = cell ? (cell.v !== null && cell.v !== undefined ? String(cell.v) : '') : ''; });
          return obj;
        });
        resolve(rows);
      } catch(e) { reject(e); }
    };
    const script = document.createElement('script');
    script.src = url;
    script.onerror = () => { delete window[cbName]; reject(new Error('Failed to load sheet')); };
    document.body.appendChild(script);
  });
}

const NAME_MERGES = {"Imthegeoff":"JellyBeanGeoff","Reindeer Smolder":"luci","Flying Squirtle":"Flyinq squirtle"};

const STATS = [
  {name:"KDA",key:"kda",fmt:"dec"},
  {name:"Kills/Game",key:"killsPerGame",fmt:"dec"},
  {name:"Deaths/Game",key:"deathsPerGame",fmt:"dec",invert:true},
  {name:"Assists/Game",key:"assistsPerGame",fmt:"dec"},
  {name:"CS/Min",key:"csPerMin",fmt:"dec"},
  {name:"Gold/Min",key:"goldPerMin",fmt:"dec"},
  {name:"Damage/Min",key:"damagePerMin",fmt:"num"},
  {name:"Vision Score/Min",key:"visionPerMin",fmt:"dec"},
  {name:"Damage Taken/Game",key:"damageTakenPerGame",fmt:"num"},
  {name:"Damage Mitigated/Game",key:"damageMitigatedPerGame",fmt:"num"},
  {name:"Win Rate %",key:"winRate",fmt:"pct"},
  {name:"Wards Placed/Game",key:"wardsPlacedPerGame",fmt:"dec"},
  {name:"Wards Killed/Game",key:"wardsKilledPerGame",fmt:"dec"},
  {name:"Control Wards/Game",key:"controlWardsPerGame",fmt:"dec"},
  {name:"Turret Kills/Game",key:"turretKillsPerGame",fmt:"dec"},
  {name:"Turret Damage/Game",key:"turretDamagePerGame",fmt:"num"},
  {name:"Objective Damage/Game",key:"objectiveDamagePerGame",fmt:"num"},
  {name:"Team Dragons/Game",key:"teamDragonsPerGame",fmt:"dec"},
  {name:"Team Barons/Game",key:"teamBaronsPerGame",fmt:"dec"},
  {name:"Team Heralds/Game",key:"teamHeraldsPerGame",fmt:"dec"},
  {name:"Team Grubs/Game",key:"teamGrubsPerGame",fmt:"dec"},
  {name:"Team Towers/Game",key:"teamTowersPerGame",fmt:"dec"},
  {name:"First Blood Rate %",key:"firstBloodRate",fmt:"pct"},
  {name:"Total Kills",key:"totalKills",fmt:"int"},
  {name:"Total Deaths",key:"totalDeaths",fmt:"int",invert:true},
  {name:"Total Assists",key:"totalAssists",fmt:"int"},
  {name:"Double Kills",key:"doubleKills",fmt:"int"},
  {name:"Triple Kills",key:"tripleKills",fmt:"int"},
  {name:"Quadra Kills",key:"quadraKills",fmt:"int"},
  {name:"Penta Kills",key:"pentaKills",fmt:"int"},
  {name:"Games Played",key:"games",fmt:"int"},
];

const TC = {
  // S1 + S2 teams
  "Literal Monkeys":"#f472b6","TFF":"#38bdf8","XSV":"#fb923c",
  "Dorado Gaming":"#a3e635","To The Moon":"#c084fc","Iridescent Dawn":"#fbbf24",
  "Definitely Not Esports":"#f87171","Legacy Esports":"#fb7185",
  "Silversong":"#2dd4bf","Final Boss":"#e879f9",
  "MINT":"#34d399","Flannel Esports":"#818cf8",
  // S3 teams
  "Flannel Equinox":"#6366f1","Astronauts":"#ef4444","Gladiators":"#f59e0b",
  "Womenphobia":"#8b5cf6","TD Phoenix":"#ec4899","Rising Tide Raiders":"#22c55e",
  "Flannel Banana Bandits":"#f97316","Dota Enjoyers":"#64748b",
  "The Everstone Elite":"#a855f7","Gamblers":"#eab308",
  // Cross-season teams
  "MetaShift":"#3b82f6","Divine Ascension":"#14b8a6",
  // Fallback
  "Sub":"#475569"
};

const ROLE_MAP = {TOP:'Top',JUNGLE:'Jng',MIDDLE:'Mid',BOTTOM:'ADC',UTILITY:'Sup'};

let PD = [], RAW = [], ROSTER = {}, curType = 'top10', comparePlayers = [], curTab = 'leaderboard';

// ════════════════════════════════════════
// TAB NAVIGATION (with URL hash)
// ════════════════════════════════════════
function switchTab(tabName, scroll) {
  curTab = tabName;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
  if (activeBtn) activeBtn.classList.add('active');
  document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
  const pg = document.getElementById('pg-'+curTab);
  if (pg) pg.classList.add('active');
  // Update URL hash without triggering scroll
  history.replaceState(null, '', '#'+curTab);
  renderCurrentTab();
  if (scroll) setTimeout(() => pg.scrollIntoView({behavior:'smooth', block:'start'}), 50);
}

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => switchTab(btn.dataset.tab, true));
});

function renderCurrentTab() {
  if (curTab === 'leaderboard') renderLeaderboard();
  else if (curTab === 'teams') renderTeams();
  else if (curTab === 'champions') renderChampions();
  else if (curTab === 'records') renderRecords();
  else if (curTab === 'mvp') renderMVP();
  else if (curTab === 'power') renderPower();
}

// ════════════════════════════════════════
// DATE HELPERS
// ════════════════════════════════════════
function parseDate(dateStr) {
  if (!dateStr) return '';
  const m = dateStr.match(/Date\((\d+),(\d+),(\d+)/);
  if (m) return `${m[1]}-${String(parseInt(m[2])+1).padStart(2,'0')}-${String(parseInt(m[3])).padStart(2,'0')}`;
  if (dateStr.includes('/')) { const p = dateStr.split('/'); return `${p[2]}-${p[0].padStart(2,'0')}-${p[1].padStart(2,'0')}`; }
  return dateStr.substring(0,10);
}
function formatDate(d) {
  if (!d) return '';
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const p = d.split('-');
  return p.length===3 ? months[parseInt(p[1])-1]+' '+parseInt(p[2])+', '+p[0] : d;
}
function fmtVal(v, fmt) {
  if (v===null||v===undefined) return '-';
  if (fmt==='pct') return v.toFixed(1)+'%';
  if (fmt==='num'||fmt==='int') return Math.round(v).toLocaleString('en-US');
  if (fmt==='dec') return v.toFixed(2);
  return v.toString();
}

// ════════════════════════════════════════
// GLOBAL FILTER
// ════════════════════════════════════════
function getFilteredRows() {
  let rows = RAW;
  const phase = document.getElementById('phaseSel').value;
  const season = document.getElementById('seasonSel').value;
  if (phase !== 'All') rows = rows.filter(r => (r['Season Phase'] || '') === phase);
  if (season !== 'All') rows = rows.filter(r => (r['Season'] || '') === season);
  return rows;
}

function onGlobalFilter() {
  const rows = getFilteredRows();
  const result = aggregate(rows, ROSTER);
  PD = result.players;
  document.getElementById('mPlayers').textContent = PD.length;
  document.getElementById('mMatches').textContent = result.totalMatches;
  document.getElementById('mNights').textContent = result.gameNights;
  document.getElementById('mDates').textContent = result.dateRange || '—';
  renderCurrentTab();
}

// ════════════════════════════════════════
// AGGREGATE
// ════════════════════════════════════════
function aggregate(matchRows, rosterMap) {
  const ps = {}, matchIds = new Set(), dates = new Set();
  // Build roster from these rows — most recent date wins
  const playerTeamDates = {}; // name -> {team, date}
  for (const r of matchRows) {
    let name = r['Summoner Name'] || '';
    if (NAME_MERGES[name]) name = NAME_MERGES[name];
    if (!name) continue;
    const team = (r['FPL Team']||'').trim();
    const dateStr = parseDate(r['Date'] || '');
    // Track most recent team per player
    if (name && team) {
      if (!playerTeamDates[name] || dateStr > playerTeamDates[name].date) {
        playerTeamDates[name] = {team, date:dateStr};
      }
    }
    matchIds.add(r['Match ID'] || '');
    dates.add(dateStr);
    if (!ps[name]) ps[name] = {games:0,kills:0,deaths:0,assists:0,cs:0,gold:0,damage:0,damageTaken:0,vision:0,duration:0,wins:0,doubles:0,triples:0,quadras:0,pentas:0,wardsPlaced:0,wardsKilled:0,controlWards:0,turretKills:0,turretDamage:0,objectiveDamage:0,damageMitigated:0,teamDragons:0,teamBarons:0,teamHeralds:0,teamGrubs:0,teamTowers:0,firstBloods:0,roles:[],champions:[]};
    const p = ps[name], n = k => parseFloat(r[k])||0;
    p.games++; p.kills+=n('Kills'); p.deaths+=n('Deaths'); p.assists+=n('Assists');
    p.cs+=n('CS'); p.gold+=n('Gold Earned'); p.damage+=n('Total Damage to Champions');
    p.damageTaken+=n('Damage Taken'); p.vision+=n('Vision Score'); p.duration+=n('Game Duration (min)');
    p.wins+=(r['Win']==='Win'?1:0); p.doubles+=n('Double Kills'); p.triples+=n('Triple Kills');
    p.quadras+=n('Quadra Kills'); p.pentas+=n('Penta Kills'); p.wardsPlaced+=n('Wards Placed');
    p.wardsKilled+=n('Wards Killed'); p.controlWards+=n('Control Wards Bought');
    p.turretKills+=n('Turret Kills'); p.turretDamage+=n('Turret Damage');
    p.objectiveDamage+=n('Objective Damage'); p.damageMitigated+=n('Damage Mitigated');
    p.teamDragons+=n('Team Dragons'); p.teamBarons+=n('Team Barons');
    p.teamHeralds+=n('Team Heralds'); p.teamGrubs+=n('Team Grubs');
    p.teamTowers+=n('Team Towers'); p.firstBloods+=(r['Team First Blood']==='Yes'?1:0);
    p.roles.push(r['Role']||'MIDDLE');
    p.champions.push({champ:r['Champion']||'Unknown', win:r['Win']==='Win', kills:n('Kills'), deaths:n('Deaths'), assists:n('Assists'), cs:n('CS'), damage:n('Total Damage to Champions'), duration:n('Game Duration (min)'), date:dateStr});
  }
  const players = [];
  for (const [name,s] of Object.entries(ps)) {
    const g=s.games, d=s.duration||1, team=(playerTeamDates[name]?playerTeamDates[name].team:null)||rosterMap[name]||'Sub';
    const mainRole = s.roles.length ? [...new Set(s.roles)].sort((a,b)=>s.roles.filter(x=>x===b).length-s.roles.filter(x=>x===a).length)[0] : 'MIDDLE';
    players.push({
      player:name, team, games:g, wins:s.wins, losses:g-s.wins,
      winRate:+(s.wins/g*100).toFixed(1),
      kda:+((s.kills+s.assists)/Math.max(s.deaths,1)).toFixed(2),
      killsPerGame:+(s.kills/g).toFixed(2), deathsPerGame:+(s.deaths/g).toFixed(2), assistsPerGame:+(s.assists/g).toFixed(2),
      csPerMin:+(s.cs/d).toFixed(2), goldPerMin:+(s.gold/d).toFixed(1), damagePerMin:+(s.damage/d).toFixed(1),
      visionPerMin:+(s.vision/d).toFixed(2),
      damageTakenPerGame:Math.round(s.damageTaken/g), damageMitigatedPerGame:Math.round(s.damageMitigated/g),
      totalKills:s.kills, totalDeaths:s.deaths, totalAssists:s.assists,
      doubleKills:s.doubles, tripleKills:s.triples, quadraKills:s.quadras, pentaKills:s.pentas,
      wardsPlacedPerGame:+(s.wardsPlaced/g).toFixed(1), wardsKilledPerGame:+(s.wardsKilled/g).toFixed(1),
      controlWardsPerGame:+(s.controlWards/g).toFixed(1),
      turretKillsPerGame:+(s.turretKills/g).toFixed(1), turretDamagePerGame:Math.round(s.turretDamage/g),
      objectiveDamagePerGame:Math.round(s.objectiveDamage/g),
      teamDragonsPerGame:+(s.teamDragons/g).toFixed(1), teamBaronsPerGame:+(s.teamBarons/g).toFixed(1),
      teamHeraldsPerGame:+(s.teamHeralds/g).toFixed(1), teamGrubsPerGame:+(s.teamGrubs/g).toFixed(1),
      teamTowersPerGame:+(s.teamTowers/g).toFixed(1),
      firstBloodRate:+(s.firstBloods/g*100).toFixed(1), mainRole,
      champData: s.champions
    });
  }
  players.sort((a,b)=>b.games-a.games);
  matchIds.delete(''); dates.delete('');
  const sortedDates=[...dates].sort();
  const dateRange=sortedDates.length?formatDate(sortedDates[0])+' — '+formatDate(sortedDates[sortedDates.length-1]):'';
  return {players, totalMatches:matchIds.size, gameNights:dates.size, dateRange};
}

// ════════════════════════════════════════
// LOAD DATA
// ════════════════════════════════════════
async function loadData() {
  try {
    const matchRows = await loadSheetJSONP('Sheet1');
    RAW = matchRows;
    ROSTER = {};
    for (const r of matchRows) {
      let name = (r['Summoner Name']||'').trim();
      const team = (r['FPL Team']||'').trim();
      if (NAME_MERGES[name]) name = NAME_MERGES[name];
      if (name && team) ROSTER[name] = team;
    }
    const result = aggregate(matchRows, ROSTER);
    PD = result.players;
    document.getElementById('mPlayers').textContent = PD.length;
    document.getElementById('mMatches').textContent = result.totalMatches;
    document.getElementById('mNights').textContent = result.gameNights;
    document.getElementById('mDates').textContent = result.dateRange;
    // Init leaderboard dropdowns
    const ss = document.getElementById('statSel');
    STATS.forEach(s => { const o=document.createElement('option'); o.value=s.key; o.textContent=s.name; ss.appendChild(o); });
    const teamSet = [...new Set(PD.map(p=>p.team))].sort();
    const tSel = document.getElementById('teamSel');
    tSel.innerHTML = '<option value="All">All Teams</option>';
    teamSet.forEach(t => { const o=document.createElement('option'); o.value=t; o.textContent=t; tSel.appendChild(o); });
    document.getElementById('mTeams').textContent = teamSet.filter(t=>t!=='Sub').length;
    // Last updated
    const now = new Date();
    document.getElementById('mUpdated').textContent = now.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})+' '+now.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
    // Show
    document.getElementById('loadingEl').style.display = 'none';
    document.getElementById('pg-leaderboard').style.display = 'block';
    // Handle URL hash for tab routing
    const hash = location.hash.replace('#','');
    const validTabs = ['leaderboard','teams','champions','records','mvp','power'];
    if (hash && validTabs.includes(hash)) switchTab(hash, false);
    else renderLeaderboard();
    // Handle ?player= URL param for shareable profiles
    const urlParams = new URLSearchParams(location.search);
    const playerParam = urlParams.get('player');
    if (playerParam) { setTimeout(()=>openProfile(decodeURIComponent(playerParam)), 200); }
  } catch(err) {
    document.getElementById('loadingEl').innerHTML = '<div class="load-error">⚠ FAILED TO LOAD<br><span style="font-size:10px;color:var(--dim)">'+err.message+'</span></div>';
  }
}

// ════════════════════════════════════════
// LEADERBOARD
// ════════════════════════════════════════
function setType(t) {
  curType=t;
  document.getElementById('bHigh').className='tbtn'+(t==='top10'?' ah':'');
  document.getElementById('bLow').className='tbtn'+(t==='bot10'?' al':'');
  document.getElementById('bAll').className='tbtn'+(t==='all'?' aa':'');
  renderLeaderboard();
}

function renderLeaderboard() {
  const rows=getFilteredRows();
  const result=aggregate(rows,ROSTER);
  PD=result.players;
  document.getElementById('mPlayers').textContent=PD.length;
  document.getElementById('mMatches').textContent=result.totalMatches;
  document.getElementById('mNights').textContent=result.gameNights;
  document.getElementById('mDates').textContent=result.dateRange||'—';
  // Refresh team dropdown to match filtered season
  const prevTeam=document.getElementById('teamSel').value;
  const teamSet=[...new Set(PD.map(p=>p.team))].sort();
  const tSel=document.getElementById('teamSel');
  tSel.innerHTML='<option value="All">All Teams</option>';
  teamSet.forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;tSel.appendChild(o);});
  if(teamSet.includes(prevTeam)) tSel.value=prevTeam; else tSel.value='All';
  document.getElementById('mTeams').textContent=teamSet.filter(t=>t!=='Sub').length;
  if(!PD.length){document.getElementById('bars').innerHTML='<div class="nodata">NO DATA</div>';return;}
  const statKey=document.getElementById('statSel').value;
  const statCfg=STATS.find(s=>s.key===statKey);
  const team=document.getElementById('teamSel').value;
  const minG=parseInt(document.getElementById('minGSel').value);
  const checkedRoles=[...document.querySelectorAll('#roleChecks input:checked')].map(c=>c.value);
  let data=PD.filter(p=>p.games>=minG).filter(p=>checkedRoles.includes(p.mainRole));
  if(team!=='All') data=data.filter(p=>p.team===team);
  const invert=statCfg&&statCfg.invert;
  data.sort((a,b)=>invert?a[statKey]-b[statKey]:b[statKey]-a[statKey]);
  data.forEach((d,i)=>d._rank=i+1);
  const search=document.getElementById('searchBar').value.toLowerCase();
  if(search){data=data.filter(p=>p.player.toLowerCase().includes(search));}
  else{if(curType==='top10')data=data.slice(0,10);else if(curType==='bot10'){data=data.reverse().slice(0,10);}}
  const arrows={top10:'▲ TOP 10',bot10:'▼ BOTTOM 10',all:'ALL PLAYERS'};
  document.getElementById('chartTitle').textContent=(statCfg?statCfg.name:statKey)+' — '+arrows[curType];
  const filters=[];
  if(team!=='All')filters.push(team.toUpperCase());
  if(checkedRoles.length<5)filters.push(checkedRoles.map(r=>ROLE_MAP[r]||r).join(', '));
  if(minG>1)filters.push(minG+'+ GAMES');
  const seasonLabel=document.getElementById('seasonSel').value==='All'?'ALL SEASONS':document.getElementById('seasonSel').value.toUpperCase();
  document.getElementById('chartSub').textContent=(filters.length?filters.join(' // ')+' // ':'')+seasonLabel;
  const barsDiv=document.getElementById('bars');
  if(!data.length){barsDiv.innerHTML='<div class="nodata">NO PLAYERS MATCH FILTERS</div>';document.getElementById('playerCount').textContent='';return;}
  const maxVal=Math.max(...data.map(d=>Math.abs(d[statKey])));
  barsDiv.innerHTML=data.map((d,i)=>{
    const pct=(Math.abs(d[statKey])/maxVal*100).toFixed(1);
    const color=TC[d.team]||'#6366f1';
    const delay=Math.min(i*0.03,1.5);
    const role=ROLE_MAP[d.mainRole]||d.mainRole;
    const sub=d.team+' · '+role+' · '+d.games+'g · '+d.winRate+'% WR';
    const rank=d._rank||i+1;
    const rc2=rank===1?'r1':rank===2?'r2':rank===3?'r3':'';
    const sel=comparePlayers.includes(d.player)?' selected':'';
    return '<div class="brow'+sel+'" style="animation-delay:'+delay+'s" onclick="toggleCompare(\''+d.player.replace(/'/g,"\\'")+'\')" ondblclick="event.stopPropagation();openProfile(\''+d.player.replace(/'/g,"\\'")+'\')">'+ 
      '<div class="rk '+rc2+'">'+rank+'</div>'+
      '<div class="pi"><div class="pn">'+d.player+'</div><div class="tn">'+sub+'</div></div>'+
      '<div class="bc"><div class="bf" style="width:'+pct+'%;background:'+color+';color:'+color+'"></div></div>'+
      '<div class="val" style="color:'+color+'">'+fmtVal(d[statKey],statCfg?statCfg.fmt:'dec')+'</div></div>';
  }).join('');
  document.getElementById('playerCount').textContent='Showing '+data.length+' of '+PD.length+' players · Double-click for player profile';
}

// ════════════════════════════════════════
// COMPARE DOCK
// ════════════════════════════════════════
const RADAR_STATS=[{key:'kda',label:'KDA',max:12},{key:'csPerMin',label:'CS/Min',max:10},{key:'goldPerMin',label:'Gold/Min',max:500},{key:'damagePerMin',label:'DMG/Min',max:800},{key:'visionPerMin',label:'Vision/Min',max:2},{key:'winRate',label:'Win Rate',max:100}];
const COMPARE_STATS=[{key:'kda',label:'KDA',fmt:'dec'},{key:'killsPerGame',label:'K/G',fmt:'dec'},{key:'deathsPerGame',label:'D/G',fmt:'dec'},{key:'assistsPerGame',label:'A/G',fmt:'dec'},{key:'csPerMin',label:'CS/M',fmt:'dec'},{key:'goldPerMin',label:'G/M',fmt:'dec'},{key:'damagePerMin',label:'DMG/M',fmt:'num'},{key:'visionPerMin',label:'VIS/M',fmt:'dec'},{key:'winRate',label:'WR%',fmt:'pct'},{key:'games',label:'Games',fmt:'int'}];

function toggleCompare(name){const i=comparePlayers.indexOf(name);if(i>=0)comparePlayers.splice(i,1);else if(comparePlayers.length<3)comparePlayers.push(name);renderCompare();document.querySelectorAll('.brow').forEach(r=>{const n=r.querySelector('.pn')?.textContent;r.classList.toggle('selected',comparePlayers.includes(n));});}
function clearCompare(){comparePlayers=[];renderCompare();document.querySelectorAll('.brow.selected').forEach(r=>r.classList.remove('selected'));}

function renderCompare(){
  const dock=document.getElementById('cmpDock'),cardsDiv=document.getElementById('cmpCards');
  if(!comparePlayers.length){dock.classList.remove('active');return;}
  dock.classList.add('active');
  const players=comparePlayers.map(n=>PD.find(p=>p.player===n)).filter(Boolean);
  if(!players.length){dock.classList.remove('active');return;}
  let html='';
  players.forEach(p=>{
    const color=TC[p.team]||'#6366f1', role=ROLE_MAP[p.mainRole]||p.mainRole;
    let stats='';
    COMPARE_STATS.forEach(s=>{const vals=players.map(pl=>pl[s.key]);const best=s.key==='deathsPerGame'?Math.min(...vals):Math.max(...vals);const isBest=players.length>1&&p[s.key]===best;stats+=`<div class="cmp-stat"><span class="cmp-label">${s.label}</span><span class="cmp-val" style="color:${isBest?color:'var(--text)'}">${fmtVal(p[s.key],s.fmt)}</span></div>`;});
    html+=`<div class="cmp-card"><div class="cmp-accent" style="background:${color}"></div><button class="cmp-remove" onclick="toggleCompare('${p.player.replace(/'/g,"\\'")}')" title="Remove">✕</button><div class="cmp-name" style="color:${color}">${p.player}</div><div class="cmp-sub">${p.team} · ${role} · ${p.games}g</div><div class="cmp-stats">${stats}</div></div>`;
  });
  for(let i=players.length;i<3;i++) html+='<div class="cmp-empty">Click a player<br>to add</div>';
  cardsDiv.innerHTML=html;
  drawRadar(players);
}

function drawRadar(players){
  const canvas=document.getElementById('radarCanvas'),ctx=canvas.getContext('2d');
  const W=canvas.width,H=canvas.height,cx=W/2,cy=H/2,R=Math.min(W,H)*.35,n=RADAR_STATS.length;
  ctx.clearRect(0,0,W,H);
  for(let ring=1;ring<=4;ring++){const r=R*ring/4;ctx.beginPath();for(let i=0;i<=n;i++){const a=Math.PI*2*i/n-Math.PI/2,x=cx+r*Math.cos(a),y=cy+r*Math.sin(a);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);}ctx.strokeStyle='#1a1a3060';ctx.lineWidth=1;ctx.stroke();}
  for(let i=0;i<n;i++){const a=Math.PI*2*i/n-Math.PI/2;ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+R*Math.cos(a),cy+R*Math.sin(a));ctx.strokeStyle='#1a1a3080';ctx.stroke();ctx.font='9px "Share Tech Mono",monospace';ctx.fillStyle='#4a5568';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(RADAR_STATS[i].label,cx+(R+18)*Math.cos(a),cy+(R+18)*Math.sin(a));}
  players.forEach(p=>{const color=TC[p.team]||'#6366f1';ctx.beginPath();for(let i=0;i<=n;i++){const si=i%n,v=Math.min(p[RADAR_STATS[si].key]/RADAR_STATS[si].max,1),r=v*R,a=Math.PI*2*si/n-Math.PI/2;i===0?ctx.moveTo(cx+r*Math.cos(a),cy+r*Math.sin(a)):ctx.lineTo(cx+r*Math.cos(a),cy+r*Math.sin(a));}ctx.closePath();ctx.fillStyle=color+'20';ctx.fill();ctx.strokeStyle=color;ctx.lineWidth=2;ctx.stroke();for(let i=0;i<n;i++){const v=Math.min(p[RADAR_STATS[i].key]/RADAR_STATS[i].max,1),r=v*R,a=Math.PI*2*i/n-Math.PI/2;ctx.beginPath();ctx.arc(cx+r*Math.cos(a),cy+r*Math.sin(a),3,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();}});
}

// ════════════════════════════════════════
// TEAMS
// ════════════════════════════════════════
function renderTeams(){
  const rows=getFilteredRows();
  // Aggregate per team
  const teams={};
  for(const r of rows){
    const team=(r['FPL Team']||'').trim();
    if(!team) continue;
    if(!teams[team]) teams[team]={wins:0,losses:0,kills:0,deaths:0,assists:0,damage:0,duration:0,games:0,players:new Set()};
    const t=teams[team];
    // Each match has 5 players per team side — count wins/losses per match not per player
    // We'll count per player-row, divide by 5 later for match count
    t.games++;
    t.wins+=(r['Win']==='Win'?1:0);
    t.losses+=(r['Win']==='Loss'?1:0);
    t.kills+=(parseFloat(r['Kills'])||0);
    t.deaths+=(parseFloat(r['Deaths'])||0);
    t.assists+=(parseFloat(r['Assists'])||0);
    t.damage+=(parseFloat(r['Total Damage to Champions'])||0);
    t.duration+=(parseFloat(r['Game Duration (min)'])||0);
    let name=r['Summoner Name']||'';
    if(NAME_MERGES[name]) name=NAME_MERGES[name];
    t.players.add(name);
  }
  const sorted=Object.entries(teams).filter(([t])=>t!=='Sub'&&t).sort((a,b)=>{
    const wrA=a[1].wins/(a[1].wins+a[1].losses)||0, wrB=b[1].wins/(b[1].wins+b[1].losses)||0;
    return wrB-wrA;
  });
  document.getElementById('teamGrid').innerHTML=sorted.map(([name,t])=>{
    const color=TC[name]||'#6366f1';
    // Each match = 5 player rows, so actual match wins/losses
    const matchWins=Math.round(t.wins/5), matchLosses=Math.round(t.losses/5);
    const wr=((matchWins/(matchWins+matchLosses))*100||0).toFixed(1);
    const avgKills=(t.kills/t.games).toFixed(1);
    const avgDeaths=(t.deaths/t.games).toFixed(1);
    const dpm=(t.damage/t.duration).toFixed(0);
    const roster=[...t.players].map(p=>`<span onclick="openProfile('${p.replace(/'/g,"\\'")}')">${p}</span>`).join(', ');
    return `<div class="team-card"><div class="tc-accent" style="background:${color}"></div><div class="tc-name" style="color:${color}">${name}</div><div class="tc-record"><span style="color:var(--green)">${matchWins}W</span> - <span style="color:var(--pink)">${matchLosses}L</span> · ${wr}% WR</div><div class="tc-stats"><div class="tc-stat"><div class="tc-stat-val" style="color:${color}">${avgKills}</div><div class="tc-stat-label">Avg K/G</div></div><div class="tc-stat"><div class="tc-stat-val" style="color:${color}">${avgDeaths}</div><div class="tc-stat-label">Avg D/G</div></div><div class="tc-stat"><div class="tc-stat-val" style="color:${color}">${dpm}</div><div class="tc-stat-label">DMG/Min</div></div></div><div class="tc-roster">${roster}</div></div>`;
  }).join('');
}

// ════════════════════════════════════════
// CHAMPIONS
// ════════════════════════════════════════
let champSort = {key:'games',asc:false};

function renderChampions(){
  const rows=getFilteredRows();
  const champs={};
  for(const r of rows){
    const c=r['Champion']||'Unknown';
    if(!champs[c]) champs[c]={games:0,wins:0,kills:0,deaths:0,assists:0,bans:0,players:new Set()};
    const ch=champs[c];
    ch.games++; ch.wins+=(r['Win']==='Win'?1:0);
    ch.kills+=(parseFloat(r['Kills'])||0); ch.deaths+=(parseFloat(r['Deaths'])||0); ch.assists+=(parseFloat(r['Assists'])||0);
    let name=r['Summoner Name']||'';if(NAME_MERGES[name])name=NAME_MERGES[name];
    ch.players.add(name);
  }
  const totalGames=rows.length;
  let data=Object.entries(champs).map(([name,c])=>({
    name, games:c.games, wins:c.wins, wr:+(c.wins/c.games*100).toFixed(1),
    kda:+((c.kills+c.assists)/Math.max(c.deaths,1)).toFixed(2),
    avgKills:+(c.kills/c.games).toFixed(1), avgDeaths:+(c.deaths/c.games).toFixed(1), avgAssists:+(c.assists/c.games).toFixed(1),
    pickRate:+(c.games/totalGames*100).toFixed(1), players:c.players.size
  }));
  data.sort((a,b)=>champSort.asc?a[champSort.key]-b[champSort.key]:b[champSort.key]-a[champSort.key]);
  if(typeof champSort.key==='string'&&champSort.key==='name') data.sort((a,b)=>champSort.asc?a.name.localeCompare(b.name):b.name.localeCompare(a.name));
  const maxGames=Math.max(...data.map(d=>d.games));
  const cols=[{key:'name',label:'Champion'},{key:'games',label:'Games'},{key:'wr',label:'Win Rate'},{key:'kda',label:'KDA'},{key:'avgKills',label:'K/G'},{key:'avgDeaths',label:'D/G'},{key:'avgAssists',label:'A/G'},{key:'pickRate',label:'Pick %'},{key:'players',label:'Players'}];
  let html='<table class="champ-table"><thead><tr>';
  cols.forEach(c=>{const sorted=champSort.key===c.key?'sorted':'';html+=`<th class="${sorted}" onclick="sortChamps('${c.key}')">${c.label}${sorted?(champSort.asc?' ▲':' ▼'):''}</th>`;});
  html+='</tr></thead><tbody>';
  data.forEach(d=>{
    const barW=(d.games/maxGames*100).toFixed(0);
    const wrColor=d.wr>=55?'var(--green)':d.wr<=45?'var(--pink)':'var(--text)';
    html+=`<tr><td class="champ-name">${d.name}</td><td>${d.games}<span class="champ-bar"><span class="champ-bar-fill" style="width:${barW}%;background:var(--cyan)"></span></span></td><td style="color:${wrColor}">${d.wr}%</td><td>${d.kda}</td><td>${d.avgKills}</td><td>${d.avgDeaths}</td><td>${d.avgAssists}</td><td>${d.pickRate}%</td><td>${d.players}</td></tr>`;
  });
  html+='</tbody></table>';
  document.getElementById('champContent').innerHTML=html;
}

function sortChamps(key){
  if(champSort.key===key) champSort.asc=!champSort.asc;
  else{champSort.key=key;champSort.asc=false;}
  renderChampions();
}

// ════════════════════════════════════════
// RECORDS
// ════════════════════════════════════════
function renderRecords(){
  const rows=getFilteredRows();
  const records=[
    {label:'Most Kills (Single Game)',key:'Kills'},
    {label:'Most Deaths (Single Game)',key:'Deaths'},
    {label:'Most Assists (Single Game)',key:'Assists'},
    {label:'Highest KDA (Single Game)',key:'_kda',calc:r=>{const k=parseFloat(r['Kills'])||0,d=parseFloat(r['Deaths'])||0,a=parseFloat(r['Assists'])||0;return (k+a)/Math.max(d,1);}},
    {label:'Most CS (Single Game)',key:'CS'},
    {label:'Most Damage (Single Game)',key:'Total Damage to Champions'},
    {label:'Most Vision Score (Single Game)',key:'Vision Score'},
    {label:'Most Gold (Single Game)',key:'Gold Earned'},
    {label:'Most Turret Kills (Single Game)',key:'Turret Kills'},
    {label:'Most Wards Placed (Single Game)',key:'Wards Placed'},
    {label:'Fastest Win (Minutes)',key:'_fastest',calc:r=>r['Win']==='Win'?(parseFloat(r['Game Duration (min)'])||999):999,invert:true},
    {label:'Longest Game (Minutes)',key:'Game Duration (min)'},
  ];
  let html='';
  records.forEach(rec=>{
    let best=null, bestVal=rec.invert?Infinity:-Infinity, bestRow=null;
    rows.forEach(r=>{
      let name=r['Summoner Name']||'';if(NAME_MERGES[name])name=NAME_MERGES[name];
      const val=rec.calc?rec.calc(r):(parseFloat(r[rec.key])||0);
      if(rec.invert?(val<bestVal):(val>bestVal)){bestVal=val;bestRow=r;best=name;}
    });
    if(!best||bestVal===Infinity||bestVal===-Infinity) return;
    const champ=bestRow?bestRow['Champion']:'';
    const date=bestRow?parseDate(bestRow['Date']||''):'';
    const team=bestRow?(bestRow['FPL Team']||''):'';
    const color=TC[team]||'var(--cyan)';
    const displayVal=rec.key==='_kda'?bestVal.toFixed(2):rec.key==='_fastest'?bestVal.toFixed(1):Math.round(bestVal).toLocaleString();
    html+=`<div class="record-card"><div class="rec-cat">${rec.label}</div><div class="rec-val" style="color:${color}">${displayVal}</div><div class="rec-player" style="cursor:pointer" onclick="openProfile('${best.replace(/'/g,"\\'")}')">${best}</div><div class="rec-detail">${champ} · ${team} · ${formatDate(date)}</div></div>`;
  });
  document.getElementById('recordsGrid').innerHTML=html;
}

// ════════════════════════════════════════
// MVP
// ════════════════════════════════════════
function calcMVPScore(p){
  // Weighted composite: KDA, Win Rate, Damage/min, CS/min, Vision/min
  return +(p.kda*2 + p.winRate*0.3 + p.damagePerMin*0.02 + p.csPerMin*3 + p.visionPerMin*10 + (p.killsPerGame-p.deathsPerGame)*2).toFixed(1);
}

function renderMVP(){
  const minG=5;
  const eligible=PD.filter(p=>p.games>=minG);
  if(!eligible.length){document.getElementById('mvpContent').innerHTML='<div class="nodata">Not enough data</div>';return;}
  eligible.forEach(p=>p.mvpScore=calcMVPScore(p));
  eligible.sort((a,b)=>b.mvpScore-a.mvpScore);
  const mvp=eligible[0];
  const color=TC[mvp.team]||'#6366f1';
  
  // Weekly MVPs — group by date
  const rows=getFilteredRows();
  const byDate={};
  for(const r of rows){
    const d=parseDate(r['Date']||'');
    if(!byDate[d]) byDate[d]=[];
    byDate[d].push(r);
  }
  const weeklyMVPs=[];
  for(const [date,gameRows] of Object.entries(byDate)){
    const agg=aggregate(gameRows,ROSTER);
    if(!agg.players.length) continue;
    agg.players.forEach(p=>p.mvpScore=calcMVPScore(p));
    agg.players.sort((a,b)=>b.mvpScore-a.mvpScore);
    const top=agg.players[0];
    weeklyMVPs.push({date,player:top.player,team:top.team,score:top.mvpScore,kda:top.kda,wr:top.winRate,games:top.games});
  }
  weeklyMVPs.sort((a,b)=>a.date.localeCompare(b.date));

  let html=`<div class="mvp-crown"><div class="mvp-label">★ Season MVP ★</div><div class="mvp-name" style="color:${color};cursor:pointer" onclick="openProfile('${mvp.player.replace(/'/g,"\\'")}')">${mvp.player}</div><div class="mvp-sub">${mvp.team} · ${ROLE_MAP[mvp.mainRole]||mvp.mainRole} · ${mvp.games} Games · ${mvp.winRate}% WR</div><div class="mvp-score">${mvp.mvpScore}</div><div class="mvp-sub">MVP RATING</div></div>`;
  
  // Top 5 runners up
  html+='<div class="card"><div class="card-t">Top 5 Overall</div><div class="card-s">Minimum '+minG+' games played</div>';
  eligible.slice(0,5).forEach((p,i)=>{
    const c=TC[p.team]||'#6366f1';
    const medals=['🥇','🥈','🥉','4.','5.'];
    html+=`<div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid #ffffff06"><span style="font-size:20px;width:30px;text-align:center">${medals[i]}</span><span style="font-weight:700;min-width:140px;cursor:pointer;color:${c}" onclick="openProfile('${p.player.replace(/'/g,"\\'")}')">${p.player}</span><span style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--dim)">${p.team} · ${p.games}g · ${p.winRate}%WR · ${p.kda} KDA</span><span style="margin-left:auto;font-family:'Orbitron',sans-serif;font-weight:700;color:${c}">${p.mvpScore}</span></div>`;
  });
  html+='</div>';

  // Weekly breakdown
  if(weeklyMVPs.length){
    html+='<div class="card"><div class="card-t">Game Night MVPs</div><div class="card-s">Best performer each night</div><div class="mvp-weekly">';
    weeklyMVPs.forEach(w=>{
      const c=TC[w.team]||'#6366f1';
      html+=`<div class="mvp-week-card"><div class="mwc-date">${formatDate(w.date)}</div><div class="mwc-name" style="color:${c}">${w.player}</div><div class="mwc-score" style="color:${c}">${w.score}</div><div class="mwc-line">${w.kda} KDA · ${w.games}g</div></div>`;
    });
    html+='</div></div>';
  }
  document.getElementById('mvpContent').innerHTML=html;
}

// ════════════════════════════════════════
// POWER RANKINGS
// ════════════════════════════════════════
function calcPowerScore(p, allPlayers){
  // Percentile-based: rank each stat among all players, average the percentiles
  const keys=['kda','winRate','csPerMin','goldPerMin','damagePerMin','visionPerMin'];
  const weights=[2.0, 1.5, 1.0, 0.8, 1.2, 0.8];
  let totalWeight=0, weightedSum=0;
  keys.forEach((k,i)=>{
    const sorted=[...allPlayers].sort((a,b)=>a[k]-b[k]);
    const rank=sorted.findIndex(x=>x.player===p.player);
    const pct=rank/(sorted.length-1||1);
    weightedSum+=pct*weights[i];
    totalWeight+=weights[i];
  });
  return +((weightedSum/totalWeight)*100).toFixed(1);
}

function renderPower(){
  const minG=parseInt(document.getElementById('prMinG').value);
  const eligible=PD.filter(p=>p.games>=minG);
  if(!eligible.length){document.getElementById('powerContent').innerHTML='<div class="nodata">Not enough data</div>';return;}
  eligible.forEach(p=>p.powerScore=calcPowerScore(p,eligible));
  eligible.sort((a,b)=>b.powerScore-a.powerScore);
  const max=eligible[0].powerScore;
  document.getElementById('powerContent').innerHTML=eligible.map((p,i)=>{
    const color=TC[p.team]||'#6366f1';
    const pct=(p.powerScore/max*100).toFixed(1);
    const delay=Math.min(i*0.03,1.5);
    const rc=i===0?'r1':i===1?'r2':i===2?'r3':'';
    return `<div class="pr-row" style="animation-delay:${delay}s"><div class="pr-rank ${rc}" style="color:${i<3?color:'var(--dim)'}">${i+1}</div><div class="pr-info"><div class="pr-name" style="color:${color}" onclick="openProfile('${p.player.replace(/'/g,"\\'")}')">${p.player}</div><div class="pr-detail">${p.team} · ${ROLE_MAP[p.mainRole]||p.mainRole} · ${p.games}g · ${p.winRate}%WR</div></div><div class="pr-bar"><div class="pr-bar-fill" style="width:${pct}%;background:${color}"></div></div><div class="pr-score" style="color:${color}">${p.powerScore}</div></div>`;
  }).join('');
}

// ════════════════════════════════════════
// PLAYER PROFILE
// ════════════════════════════════════════
function openProfile(playerName){
  const p=PD.find(x=>x.player===playerName);
  if(!p){return;}
  const color=TC[p.team]||'#6366f1';
  const role=ROLE_MAP[p.mainRole]||p.mainRole;
  
  // Power score
  const eligible=PD.filter(x=>x.games>=3);
  eligible.forEach(x=>x.powerScore=calcPowerScore(x,eligible));
  eligible.sort((a,b)=>b.powerScore-a.powerScore);
  const powerRank=eligible.findIndex(x=>x.player===playerName)+1;
  const powerScore=p.powerScore||calcPowerScore(p,eligible);

  // Champion breakdown
  const champMap={};
  (p.champData||[]).forEach(c=>{
    if(!champMap[c.champ]) champMap[c.champ]={games:0,wins:0,kills:0,deaths:0,assists:0};
    const ch=champMap[c.champ];
    ch.games++;ch.wins+=(c.win?1:0);ch.kills+=c.kills;ch.deaths+=c.deaths;ch.assists+=c.assists;
  });
  const champList=Object.entries(champMap).map(([name,c])=>({
    name,games:c.games,wr:+(c.wins/c.games*100).toFixed(0),
    kda:+((c.kills+c.assists)/Math.max(c.deaths,1)).toFixed(2)
  })).sort((a,b)=>b.games-a.games);

  // Stat ranks among all players
  function getRank(key, invert){
    const sorted=[...PD].sort((a,b)=>invert?a[key]-b[key]:b[key]-a[key]);
    return sorted.findIndex(x=>x.player===playerName)+1;
  }

  // Vs league average
  const avg={};
  const statKeys=['kda','killsPerGame','deathsPerGame','assistsPerGame','csPerMin','goldPerMin','damagePerMin','visionPerMin','winRate'];
  statKeys.forEach(k=>{
    const vals=PD.filter(x=>x.games>=3).map(x=>x[k]);
    avg[k]=vals.length?+(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2):0;
  });

  // Trend data — performance by date
  const datePerf={};
  (p.champData||[]).forEach(c=>{
    if(!datePerf[c.date]) datePerf[c.date]={kills:0,deaths:0,assists:0,games:0,wins:0,damage:0,duration:0};
    const dp=datePerf[c.date];
    dp.games++;dp.kills+=c.kills;dp.deaths+=c.deaths;dp.assists+=c.assists;dp.wins+=(c.win?1:0);dp.damage+=c.damage;dp.duration+=c.duration;
  });
  const trendDates=Object.keys(datePerf).sort();
  const trendKDA=trendDates.map(d=>{const dp=datePerf[d];return +((dp.kills+dp.assists)/Math.max(dp.deaths,1)).toFixed(2);});

  let html=`<div class="prof-header"><div><div class="prof-name" style="color:${color}">${p.player}</div><div class="prof-sub">${p.team} · ${role} · ${p.games} Games · ${p.wins}W ${p.losses}L</div></div><div style="display:flex;align-items:center"><div class="prof-rating" style="color:${color}" title="Power Rating">${powerScore}<span style="font-size:12px;color:var(--dim)"> #${powerRank}</span></div><button class="prof-share" onclick="shareProfile('${p.player.replace(/'/g,"\\'")}')">⚡ SHARE</button></div></div>`;

  // Core stats
  html+='<div class="prof-section"><div class="prof-section-title">Core Stats</div><div class="prof-stats">';
  const coreStats=[
    {label:'KDA',val:p.kda,fmt:'dec',key:'kda'},{label:'Win Rate',val:p.winRate,fmt:'pct',key:'winRate'},
    {label:'K/G',val:p.killsPerGame,fmt:'dec',key:'killsPerGame'},{label:'D/G',val:p.deathsPerGame,fmt:'dec',key:'deathsPerGame',inv:true},
    {label:'A/G',val:p.assistsPerGame,fmt:'dec',key:'assistsPerGame'},{label:'CS/Min',val:p.csPerMin,fmt:'dec',key:'csPerMin'},
    {label:'Gold/Min',val:p.goldPerMin,fmt:'dec',key:'goldPerMin'},{label:'DMG/Min',val:p.damagePerMin,fmt:'num',key:'damagePerMin'},
    {label:'Vision/Min',val:p.visionPerMin,fmt:'dec',key:'visionPerMin'},{label:'Games',val:p.games,fmt:'int',key:'games'},
  ];
  coreStats.forEach(s=>{
    const rank=getRank(s.key,s.inv);
    const rankColor=rank<=3?'var(--gold)':rank<=10?'var(--cyan)':'var(--dim)';
    html+=`<div class="prof-stat"><div class="prof-stat-val" style="color:${color}">${fmtVal(s.val,s.fmt)}</div><div class="prof-stat-label">${s.label}</div><div class="prof-stat-rank" style="color:${rankColor}">#${rank} of ${PD.length}</div></div>`;
  });
  html+='</div></div>';

  // Vs League Average
  html+='<div class="prof-section"><div class="prof-section-title">Vs League Average</div><div class="prof-vs-avg">';
  statKeys.forEach(k=>{
    const s=STATS.find(x=>x.key===k)||{name:k,fmt:'dec'};
    const diff=p[k]-avg[k];
    const diffColor=k==='deathsPerGame'?(diff<0?'var(--green)':'var(--pink)'):(diff>0?'var(--green)':'var(--pink)');
    const diffStr=(diff>0?'+':'')+fmtVal(diff,s.fmt);
    html+=`<div class="prof-vs"><span class="pvl">${s.name}</span><span class="pvv">${fmtVal(p[k],s.fmt)}</span><span class="pvd" style="color:${diffColor}">${diffStr}</span></div>`;
  });
  html+='</div></div>';

  // Champion Pool
  if(champList.length){
    html+='<div class="prof-section"><div class="prof-section-title">Champion Pool</div><div class="prof-champs">';
    champList.forEach(c=>{
      const wrColor=c.wr>=55?'var(--green)':c.wr<=45?'var(--pink)':'var(--text)';
      html+=`<div class="prof-champ"><div><div class="prof-champ-name">${c.name}</div><div class="prof-champ-games">${c.games} games · ${c.kda} KDA</div></div><div class="prof-champ-wr" style="color:${wrColor}">${c.wr}%</div></div>`;
    });
    html+='</div></div>';
  }

  // Trend
  if(trendDates.length>1){
    html+='<div class="prof-section"><div class="prof-section-title">KDA Trend by Game Night</div><div class="prof-trend"><canvas id="trendCanvas" width="850" height="120"></canvas></div></div>';
  }

  // Multi-kills
  if(p.doubleKills||p.tripleKills||p.quadraKills||p.pentaKills){
    html+='<div class="prof-section"><div class="prof-section-title">Multi-Kills</div><div class="prof-stats">';
    [{l:'Doubles',v:p.doubleKills},{l:'Triples',v:p.tripleKills},{l:'Quadras',v:p.quadraKills},{l:'Pentas',v:p.pentaKills}].forEach(m=>{
      if(m.v) html+=`<div class="prof-stat"><div class="prof-stat-val" style="color:${color}">${m.v}</div><div class="prof-stat-label">${m.l}</div></div>`;
    });
    html+='</div></div>';
  }

  document.getElementById('profileContent').innerHTML=html;
  document.getElementById('profileModal').classList.add('active');

  // Draw trend chart after DOM update
  if(trendDates.length>1){
    setTimeout(()=>drawTrend(trendDates,trendKDA,color),50);
  }
}

function drawTrend(dates,values,color){
  const canvas=document.getElementById('trendCanvas');
  if(!canvas) return;
  const ctx=canvas.getContext('2d');
  const W=canvas.width,H=canvas.height,pad=30;
  ctx.clearRect(0,0,W,H);
  const minV=Math.min(...values)*0.8, maxV=Math.max(...values)*1.2;
  const xStep=(W-pad*2)/(dates.length-1||1);
  // Grid
  ctx.strokeStyle='#1a1a3040';ctx.lineWidth=1;
  for(let i=0;i<4;i++){const y=pad+(H-pad*2)*i/3;ctx.beginPath();ctx.moveTo(pad,y);ctx.lineTo(W-pad,y);ctx.stroke();}
  // Line
  ctx.beginPath();ctx.strokeStyle=color;ctx.lineWidth=2;
  const pts=[];
  values.forEach((v,i)=>{const x=pad+i*xStep,y=H-pad-(v-minV)/(maxV-minV||1)*(H-pad*2);pts.push({x,y});i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
  ctx.stroke();
  // Fill
  ctx.lineTo(pts[pts.length-1].x,H-pad);ctx.lineTo(pts[0].x,H-pad);ctx.closePath();ctx.fillStyle=color+'15';ctx.fill();
  // Dots + labels
  pts.forEach((pt,i)=>{ctx.beginPath();ctx.arc(pt.x,pt.y,4,0,Math.PI*2);ctx.fillStyle=color;ctx.fill();ctx.font='9px "Share Tech Mono",monospace';ctx.fillStyle='var(--dim)';ctx.textAlign='center';ctx.fillText(values[i].toFixed(1),pt.x,pt.y-10);ctx.fillText(dates[i].slice(5),pt.x,H-8);});
}

function closeProfile(){document.getElementById('profileModal').classList.remove('active');history.replaceState(null,'',location.pathname+'#'+curTab);}
document.getElementById('profileModal').addEventListener('click',e=>{if(e.target===document.getElementById('profileModal'))closeProfile();});

// ════════════════════════════════════════
// SHARE / URL UTILITIES
// ════════════════════════════════════════
function shareProfile(playerName) {
  const url = location.origin + location.pathname + '?player=' + encodeURIComponent(playerName);
  navigator.clipboard.writeText(url).then(() => showToast('Link copied to clipboard!')).catch(() => {
    // Fallback
    prompt('Copy this link:', url);
  });
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// ════════════════════════════════════════
// BACK TO TOP
// ════════════════════════════════════════
window.addEventListener('scroll', () => {
  document.getElementById('bttBtn').classList.toggle('show', window.scrollY > 400);
});

// ════════════════════════════════════════
// GO!
// ════════════════════════════════════════
loadData();
</script>
</body>
</html>
